cmake_minimum_required(VERSION 3.5)
project(rclada_common VERSION 0.1.0)

message(STATUS " ")
message(STATUS "${PROJECT_NAME} version ${PROJECT_VERSION}")

find_package(ament_cmake REQUIRED)
find_package(ament_index_cpp REQUIRED)

# Detect builder and compiler

find_program(GPRBUILD gprbuild)
if (NOT GPRBUILD)
  message(SEND_ERROR "gprbuild must be available in PATH")
endif()

find_program(GNAT gnat)
if (NOT GNAT)
  message(SEND_ERROR "gnat must be available in PATH")
endif()

# Initialize Ada paths

set(ADA_GPR_DIRS ${CMAKE_INSTALL_PREFIX}/share/gpr)
# Here we deploy projects that have manual sources
# Even if they include a "gen" folder autogenerated
# These have to be developed in GPS using the real source folder

# list(APPEND ADA_GPR_DIRS ${CMAKE_INSTALL_PREFIX}/share/gprimport)
# Here we deploy imported external libraries
# These projects can't be edited, but must be used while developing
# To avoid duplication of the manual/installed projects, we need to separate like this.

set(ADA_RESOURCE_DIR ${PROJECT_SOURCE_DIR}/resources)
# Templates used for generated files

# Ada CMake functions
install(DIRECTORY cmake
        DESTINATION ${CMAKE_INSTALL_PREFIX}/share/${PROJECT_NAME})

list(APPEND CMAKE_MODULE_PATH ${PROJECT_SOURCE_DIR}/cmake)
include(ada_project)

# ada_begin_package()
# We do not need this since paths have been just initialized

# Generate some common C headers used by rosidl, rclada...
ada_generate_binding(
        ada_specs_common
        gpr_c_builtins
        c_builtins.gpr
        ""
        /usr/include/${CMAKE_LIBRARY_ARCHITECTURE}/bits/stdint-intn.h
        /usr/include/${CMAKE_LIBRARY_ARCHITECTURE}/bits/stdint-uintn.h
        /usr/include/${CMAKE_LIBRARY_ARCHITECTURE}/bits/types.h)

# Add AAA lib for use in Ada ament lib
ada_add_library(
  aaa_lib
  gpr_aaa
  aaa.gpr
)

# Export C_Strings for reuse here and rosidl
ada_add_library(
  c_strings_lib
  gpr_cstrings
  c_strings.gpr
)

# Import ament_index_cpp lib for our Ada ament lib
ada_import_c_libraries(${ament_index_cpp_LIBRARIES})

# Export the Ada ament library
ada_add_library(
  ada_ament_lib
  gpr_ament
  ament.gpr
)
add_dependencies(ada_ament_lib aaa_lib c_strings_lib)

ada_end_package()